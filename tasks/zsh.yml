---
- name: Install ZSH for Linux
  package:
    name: zsh
    state: present
  become: true
  when: ansible_facts['os_family'] == "RedHat"

- name: Install ZSH for macOS
  homebrew:
    name: zsh
    state: present
  when: ansible_facts['os_family'] == "Darwin"

- name: Check ZSH path
  command: which zsh
  changed_when: false
  register: zsh_path

- name: Install oh-my-zsh
  git:
    repo: https://github.com/ohmyzsh/ohmyzsh.git
    dest: ~/.oh-my-zsh
    version: master

- name: Check if zsh profile exist
  stat:
    path: ~/.zshrc
  register: zsh_profile

- name: Backup zsh profile
  copy:
    src: ~/.zshrc
    dest: ~/.zshrc.backup
    remote_src: yes
  when: zsh_profile.stat.exists and zsh_profile_overwrite

- name: Copy zsh config template
  copy:
    src: ~/.oh-my-zsh/templates/zshrc.zsh-template
    dest: ~/.zshrc
    remote_src: yes
  when: |
    not zsh_profile.stat.exists or
    (zsh_profile.stat.exists and zsh_profile_overwrite)

- name: Set default shell to zsh for current user
  user:
    name: "{{ ansible_env.USER }}"
    shell: "{{ zsh_path.stdout }}"
  become: true
